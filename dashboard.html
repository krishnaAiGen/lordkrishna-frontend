<!doctype html>
<html class="no-js" lang="zxx">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Dashboard - LordKrishna Consultancy</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicon.ico">

        <!-- CSS here -->
        <link rel="stylesheet" href="assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/css/owl.carousel.min.css">
        <link rel="stylesheet" href="assets/css/slicknav.css">
        <link rel="stylesheet" href="assets/css/animate.min.css">
        <link rel="stylesheet" href="assets/css/magnific-popup.css">
        <link rel="stylesheet" href="assets/css/fontawesome-all.min.css">
        <link rel="stylesheet" href="assets/css/themify-icons.css">
        <link rel="stylesheet" href="assets/css/slick.css">
        <link rel="stylesheet" href="assets/css/nice-select.css">
        <link rel="stylesheet" href="assets/css/style.css">
        
        <style>
            body {
                visibility: hidden;
            }
            .dashboard-container {
                max-width: 1200px;
                margin: 50px auto;
                padding: 20px;
            }
            .section-card {
                background: #fff;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 30px;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            .form-group {
                margin-bottom: 20px;
            }
            .submit-btn {
                background: #ff5c97;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                transition: 0.3s;
            }
            .submit-btn:hover {
                background: #ff3c7f;
            }
            .report-table {
                width: 100%;
                margin-top: 20px;
            }
            .report-table th, .report-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            .report-table th {
                background-color: #f8f9fa;
            }
            .logout-btn {
                position: absolute;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                background: #ff5c97;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                text-decoration: none;
            }
            .logout-btn:hover {
                background: #ff3c7f;
                color: white;
            }
            .nav-tabs .nav-link {
                color: #333;
                font-weight: 600;
            }
            .nav-tabs .nav-link.active {
                color: #ff5c97;
                border-color: #ff5c97;
            }
            .form-section {
                margin-bottom: 30px;
                padding: 20px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .form-section h3 {
                margin-bottom: 20px;
                color: #333;
            }
            .coordinates-section {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 20px;
            }
        </style>
    </head>

    <body>
        <!-- Header Start -->
        <header>
            <div class="header-area header-transparent">
                <div class="main-header header-sticky">
                    <div class="container-fluid">
                        <div class="row align-items-center">
                            <div class="col-xl-2 col-lg-2 col-md-1">
                                <div class="logo">
                                    <a href="welcome.html" class="big-logo"><img src="assets/img/logo/logo.png" alt=""></a>
                                </div>
                            </div>
                            <div class="col-xl-10 col-lg-10 col-md-10">
                                <a href="welcome.html" class="btn btn-primary" style="margin-right: 20px;">Back</a>
                                <a href="login.html" class="logout-btn">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Header End -->

        <main>
            <div class="dashboard-container">
                <div class="section-card">
                    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="submit-tab" data-toggle="tab" href="#submit" role="tab">Field Report Submission</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="view-tab" data-toggle="tab" href="#view" role="tab">View Field Reports</a>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="dashboardTabContent">
                        <!-- Submit Report Tab -->
                        <div class="tab-pane fade show active" id="submit" role="tabpanel">
                            <form id="fieldReportForm" onsubmit="return handleReportSubmission(event)">
                                <!-- 1. Client Information -->
                                <div class="form-section">
                                    <h3>1. Client Information</h3>
                                    <div class="form-group">
                                        <label>Client/Owner/Representative Name</label>
                                        <input type="text" class="form-control" name="clientName">
                                    </div>
                                    <div class="form-group">
                                        <label>Serial Number</label>
                                        <input type="text" class="form-control" name="serialNumber">
                                    </div>
                                    <div class="form-group">
                                        <label>Bank/Branch Name</label>
                                        <input type="text" class="form-control" name="bankName">
                                    </div>
                                    <div class="form-group">
                                        <label>Contact Number</label>
                                        <input type="tel" class="form-control" name="contactNumber">
                                    </div>
                                </div>

                                <!-- 2. Plot Details -->
                                <div class="form-section">
                                    <h3>2. Plot Details</h3>
                                    <div class="form-group">
                                        <label>Plot No</label>
                                        <input type="text" class="form-control" name="plotNo">
                                    </div>
                                    <div class="form-group">
                                        <label>Plot Area</label>
                                        <input type="text" class="form-control" name="plotArea">
                                    </div>
                                    <div class="form-group">
                                        <label>Location (Tole Name)</label>
                                        <input type="text" class="form-control" name="toleName">
                                    </div>
                                    <div class="form-group">
                                        <label>Boundaries Analysis of Plot</label>
                                        <textarea class="form-control" name="boundariesAnalysis" rows="4"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Dimensions (According to Field)</label>
                                        <input type="text" class="form-control" name="fieldDimensions">
                                    </div>
                                    <div class="form-group">
                                        <label>Dimensions (Cadastral Map)</label>
                                        <input type="text" class="form-control" name="cadastralDimensions">
                                    </div>
                                    <div class="form-group">
                                        <label>Width of Road (Cadastral Map)</label>
                                        <input type="text" class="form-control" name="roadWidthCadastral">
                                    </div>
                                    <div class="form-group">
                                        <label>Width of Road (Right of Way)</label>
                                        <input type="text" class="form-control" name="roadWidthRightOfWay">
                                    </div>
                                    <div class="form-group">
                                        <label>Width of Road (Type of Road)</label>
                                        <input type="text" class="form-control" name="roadType">
                                    </div>
                                    <div class="form-group">
                                        <label>Other Factors Affecting Property</label>
                                        <textarea class="form-control" name="otherFactors" rows="4"></textarea>
                                    </div>
                                </div>

                                <!-- 3. Land Status and Use -->
                                <div class="form-section">
                                    <h3>3. Land Status and Use</h3>
                                    <div class="form-group">
                                        <label>Current Land Status</label>
                                        <input type="text" class="form-control" name="landStatus">
                                    </div>
                                    <div class="form-group">
                                        <label>Current Land Use</label>
                                        <input type="text" class="form-control" name="landUse">
                                    </div>
                                    <div class="form-group">
                                        <label>Current Land Grading</label>
                                        <input type="text" class="form-control" name="landGrading">
                                    </div>
                                    <div class="form-group">
                                        <label>Current Surrounding Property</label>
                                        <textarea class="form-control" name="surroundingProperty" rows="4"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Requirement of Filling</label>
                                        <input type="text" class="form-control" name="fillingRequirement">
                                    </div>
                                    <div class="form-group">
                                        <label>Importance of Area</label>
                                        <textarea class="form-control" name="areaImportance" rows="4"></textarea>
                                    </div>
                                </div>

                                <!-- 4. Document Verification -->
                                <div class="form-section">
                                    <h3>4. Document Verification</h3>
                                    <div class="form-group">
                                        <label>All Required Documents Provided?</label>
                                        <select class="form-control" name="documentsProvided">
                                            <option value="yes">Yes</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Does the Shape of Land & Surrounding Features Match the Cadastral Map?</label>
                                        <select class="form-control" name="shapeMatch">
                                            <option value="yes">Yes</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 5. Distances & Location Factors -->
                                <div class="form-section">
                                    <h3>5. Distances & Location Factors</h3>
                                    <div class="form-group">
                                        <label>Nearest Landmarks and Reference Points</label>
                                        <textarea class="form-control" name="landmarks" rows="4"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>High Tension Line (Proximity)</label>
                                        <input type="text" class="form-control" name="tensionLineProximity">
                                    </div>
                                    <div class="form-group">
                                        <label>River/Water Body Proximity</label>
                                        <input type="text" class="form-control" name="waterBodyProximity">
                                    </div>
                                    <div class="form-group">
                                        <label>Distance from International Border/Railway Alignment</label>
                                        <input type="text" class="form-control" name="borderDistance">
                                    </div>
                                    <div class="form-group">
                                        <label>Government Notifications</label>
                                        <textarea class="form-control" name="govtNotifications" rows="4"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Property Photos</label>
                                        <input type="file" class="form-control" name="propertyPhotos" multiple accept="image/*">
                                    </div>
                                    <div class="coordinates-section">
                                        <label>GPS Coordinates</label>
                                        <div id="gpsCoordinates">Loading coordinates...</div>
                                        <div id="manualCoordinates" style="display: none; margin-top: 15px;">
                                            <div class="form-group">
                                                <label>Manual Latitude</label>
                                                <input type="number" step="any" class="form-control" id="manualLatitude" placeholder="Enter latitude">
                                            </div>
                                            <div class="form-group">
                                                <label>Manual Longitude</label>
                                                <input type="number" step="any" class="form-control" id="manualLongitude" placeholder="Enter longitude">
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-primary mt-2" id="toggleManualCoords">Enter Coordinates Manually</button>
                                    </div>
                                </div>

                                <!-- 6. Building & Construction Details -->
                                <div class="form-section">
                                    <h3>6. Building & Construction Details</h3>
                                    <div class="form-group">
                                        <label>Constructed as per Approved Drawing?</label>
                                        <select class="form-control" name="constructionApproval">
                                            <option value="yes">Yes</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Construction Completion Certificate</label>
                                        <input type="file" class="form-control" name="completionCertificate" accept=".pdf,.jpg,.jpeg,.png">
                                    </div>
                                    <div class="form-group">
                                        <label>Type of Structure</label>
                                        <input type="text" class="form-control" name="structureType">
                                    </div>
                                    <div class="form-group">
                                        <label>Year of Completion</label>
                                        <input type="number" class="form-control" name="completionYear">
                                    </div>
                                    <div class="form-group">
                                        <label>Number of Completed Floors</label>
                                        <input type="number" class="form-control" name="completedFloors">
                                    </div>
                                    <div class="form-group">
                                        <label>Maintenance Requirements</label>
                                        <textarea class="form-control" name="maintenanceReq" rows="4"></textarea>
                                    </div>
                                </div>

                                <!-- 7. Market Rate -->
                                <div class="form-section">
                                    <h3>7. Market Rate (Neighborhood Findings)</h3>
                                    <div class="form-group">
                                        <label>Market Rate (Person-1)</label>
                                        <input type="text" class="form-control" name="marketRate1">
                                    </div>
                                    <div class="form-group">
                                        <label>Market Rate (Person-2)</label>
                                        <input type="text" class="form-control" name="marketRate2">
                                    </div>
                                    <div class="form-group">
                                        <label>Market Rate (Person-3)</label>
                                        <input type="text" class="form-control" name="marketRate3">
                                    </div>
                                    <div class="form-group">
                                        <label>Market Rate (Person-4)</label>
                                        <input type="text" class="form-control" name="marketRate4">
                                    </div>
                                    <div class="form-group">
                                        <label>Market Rate (Person-5)</label>
                                        <input type="text" class="form-control" name="marketRate5">
                                    </div>
                                </div>

                                <!-- 8. Valuation Summary -->
                                <div class="form-section">
                                    <h3>8. Valuation Summary</h3>
                                    <div class="form-group">
                                        <label>Valuer's Opinion</label>
                                        <textarea class="form-control" name="valuersOpinion" rows="4"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Basis/Bases of Value</label>
                                        <textarea class="form-control" name="valueBasis" rows="4"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Valuator Name</label>
                                        <input type="text" class="form-control" name="valuatorName">
                                    </div>
                                </div>

                                <button type="submit" class="submit-btn">Submit Report</button>
                            </form>
                        </div>

                        <!-- View Reports Tab -->
                        <div class="tab-pane fade" id="view" role="tabpanel">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="searchClientName" placeholder="Search by client name...">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="searchDate" placeholder="Search by date (DD/MM/YYYY)...">
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Client Name</th>
                                            <th>Location</th>
                                            <th>Serial Number</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportTableBody">
                                        <!-- Reports will be dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            // Authentication check - Must be at the top
            function checkAuthentication() {
                const username = localStorage.getItem('username');
                const token = localStorage.getItem('token');
                if (!username || !token) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            }

            // Immediately check authentication when page loads
            if (!checkAuthentication()) {
                throw new Error('Authentication check failed');
            }

            // Initialize the dashboard
            async function initializeDashboard() {
                try {
                    // Make body visible after authentication check
                    document.body.style.visibility = 'visible';
                    
                    // Initialize GPS coordinates
                    getGPSCoordinates();
                    
                    // Load reports
                    await loadReports();

                    // Connect form submission handler
                    const fieldReportForm = document.getElementById('fieldReportForm');
                    if (fieldReportForm) {
                        // Remove any existing event listeners
                        fieldReportForm.removeEventListener('submit', handleReportSubmission);
                        // Add new event listener
                        fieldReportForm.addEventListener('submit', handleReportSubmission);
                        console.log('Field report form submission handler connected');
                    } else {
                        console.error('Field report form not found');
                    }

                    // Add search event listeners
                    const searchClientName = document.getElementById('searchClientName');
                    const searchDate = document.getElementById('searchDate');
                    
                    if (searchClientName) {
                        searchClientName.addEventListener('input', filterAndDisplayReports);
                    }
                    if (searchDate) {
                        searchDate.addEventListener('input', filterAndDisplayReports);
                    }

                    // Handle tab activation from welcome page
                    const activeTab = localStorage.getItem('activeTab');
                    if (activeTab) {
                        // Activate the correct tab
                        $(`#dashboardTabs a[href="#${activeTab}"]`).tab('show');
                        // Clear the stored tab
                        localStorage.removeItem('activeTab');
                    }

                    // Also handle direct hash in URL
                    const hash = window.location.hash.substring(1);
                    if (hash === 'submit' || hash === 'view') {
                        $(`#dashboardTabs a[href="#${hash}"]`).tab('show');
                    }
                    
                    console.log('Dashboard initialized successfully');
                } catch (error) {
                    console.error('Error initializing dashboard:', error);
                    alert('Error initializing dashboard. Please refresh the page or try logging in again.');
                }
            }

            // Initialize when DOM is ready
            document.addEventListener('DOMContentLoaded', initializeDashboard);

            // Get GPS coordinates
            function getGPSCoordinates() {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const coordinates = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        document.getElementById('gpsCoordinates').innerHTML = 
                            `Latitude: ${coordinates.latitude}<br>Longitude: ${coordinates.longitude}`;
                        // Store coordinates in hidden inputs
                        const form = document.getElementById('fieldReportForm');
                        form.dataset.latitude = coordinates.latitude;
                        form.dataset.longitude = coordinates.longitude;
                    }, function(error) {
                        document.getElementById('gpsCoordinates').innerHTML = 
                            "Error getting coordinates. Please enter them manually.";
                        // Show manual input fields when there's an error
                        document.getElementById('manualCoordinates').style.display = 'block';
                    });
                } else {
                    document.getElementById('gpsCoordinates').innerHTML = 
                        "Geolocation is not supported. Please enter coordinates manually.";
                    // Show manual input fields when geolocation is not supported
                    document.getElementById('manualCoordinates').style.display = 'block';
                }
            }

            // Handle manual coordinates toggle
            document.getElementById('toggleManualCoords').addEventListener('click', function() {
                const manualCoords = document.getElementById('manualCoordinates');
                if (manualCoords.style.display === 'none') {
                    manualCoords.style.display = 'block';
                    this.textContent = 'Hide Manual Entry';
                } else {
                    manualCoords.style.display = 'none';
                    this.textContent = 'Enter Coordinates Manually';
                }
            });

            // Handle report submission
            async function handleReportSubmission(event) {
                event.preventDefault();
                
                const username = localStorage.getItem('username');
                const token = localStorage.getItem('token');
                
                if (!username || !token) {
                    alert('Please login again');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // Show loading indicator
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                
                const form = event.target;
                const formData = new FormData(form);
                const data = {};
                
                try {
                    // Collect all form fields
                    formData.forEach((value, key) => {
                        // Skip empty values and file inputs
                        if (value && !(form.elements[key] && form.elements[key].type === 'file')) {
                            data[key] = value;
                        }
                    });

                    // Add GPS coordinates if available
                    const manualLatitude = document.getElementById('manualLatitude').value;
                    const manualLongitude = document.getElementById('manualLongitude').value;
                    if (manualLatitude && manualLongitude) {
                        data.gpsCoordinates = {
                            latitude: parseFloat(manualLatitude),
                            longitude: parseFloat(manualLongitude)
                        };
                    } else if (form.dataset.latitude && form.dataset.longitude) {
                        data.gpsCoordinates = {
                            latitude: parseFloat(form.dataset.latitude),
                            longitude: parseFloat(form.dataset.longitude)
                        };
                    }
                    
                    // Add metadata
                    data.timestamp = new Date().toISOString();
                    data.username = username;
                    
                    const apiUrl = `${window.API_CONFIG.BASE_URL}/api/submit-report`;
                    console.log('Submitting report to:', apiUrl);
                    console.log('Report data:', data);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                            'X-Username': username
                        },
                        body: JSON.stringify(data)
                    });
                    
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        
                        if (response.status === 401) {
                            throw new Error('Session expired. Please login again.');
                        } else {
                            throw new Error(`Server error: ${response.status} ${response.statusText}`);
                        }
                    }
                    
                    const result = await response.json();
                    console.log('Response data:', result);
                    
                    if (!result.success) {
                        throw new Error(result.message || 'Unknown error occurred');
                    }
                    
                    // Success handling
                    alert('Report submitted successfully!');
                    form.reset();
                    
                    // Switch to the view tab and refresh the reports list
                    $('#dashboardTabs a[href="#view"]').tab('show');
                    await loadReports();
                    
                } catch (error) {
                    console.error('Error submitting report:', error);
                    
                    if (error.message.includes('Session expired')) {
                        alert('Session expired. Please login again.');
                        window.location.href = 'login.html';
                    } else {
                        alert('Error submitting report: ' + error.message + '\nPlease try again.');
                    }
                } finally {
                    // Restore button state
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
                
                return false;
            }

            // Load reports
            async function loadReports() {
                const username = localStorage.getItem('username');
                const token = localStorage.getItem('token');
                
                if (!username || !token) {
                    alert('Please login again');
                    window.location.href = 'login.html';
                    return;
                }

                // Show loading indicator
                const tableBody = document.getElementById('reportTableBody');
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Loading reports...</td></tr>';

                try {
                    const apiUrl = `${window.API_CONFIG.BASE_URL}/api/get-reports`;
                    console.log('Fetching reports from:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                            'X-Username': username
                        },
                        cache: 'no-store'
                    });
                    
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Session expired. Please login again.');
                            window.location.href = 'login.html';
                            return;
                        }
                        
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        throw new Error(`Failed to load reports: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('Reports data received:', data);
                    
                    if (!data || !Array.isArray(data.reports)) {
                        throw new Error('Invalid data format received from server');
                    }
                    
                    window.reportData = data.reports;
                    filterAndDisplayReports();
                    
                    // Update the UI to show total number of reports
                    const totalReports = data.reports.length;
                    const searchInfo = document.createElement('p');
                    searchInfo.className = 'text-muted mt-2';
                    searchInfo.textContent = `Total reports: ${totalReports}`;
                    tableBody.parentElement.insertBefore(searchInfo, tableBody);
                    
                } catch (error) {
                    console.error('Error loading reports:', error);
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;"><div class="alert alert-danger">' +
                        '<p><strong>Error loading reports:</strong> ' + error.message + '</p>' +
                        '<p>Please check your internet connection and try again.</p>' +
                        '<button class="btn btn-sm btn-primary mt-2" onclick="loadReports()">Retry</button></div></td></tr>';
                }
            }

            // Function to filter and display reports
            function filterAndDisplayReports() {
                const clientNameSearch = document.getElementById('searchClientName').value.toLowerCase();
                const dateSearch = document.getElementById('searchDate').value;
                
                let filteredReports = window.reportData;
                
                if (clientNameSearch) {
                    filteredReports = filteredReports.filter(report => 
                        (report.clientName || '').toLowerCase().includes(clientNameSearch)
                    );
                }
                
                if (dateSearch) {
                    filteredReports = filteredReports.filter(report => {
                        const reportDate = new Date(report.timestamp).toLocaleDateString('en-GB');
                        return reportDate === dateSearch;
                    });
                }
                
                const tableBody = document.getElementById('reportTableBody');
                tableBody.innerHTML = '';
                
                if (filteredReports.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No reports found</td></tr>';
                    return;
                }

                filteredReports.forEach(report => {
                    const row = document.createElement('tr');
                    const date = new Date(report.timestamp).toLocaleDateString('en-GB');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${report.clientName || 'N/A'}</td>
                        <td>${report.toleName || 'N/A'}</td>
                        <td>${report.serialNumber || 'N/A'}</td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="actionBtn_${report.id}" 
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Actions
                                </button>
                                <div class="dropdown-menu" aria-labelledby="actionBtn_${report.id}">
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="viewReport('${report.id}')">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="updateReport('${report.id}')">
                                        <i class="fas fa-edit"></i> Update
                                    </a>
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="downloadReport('${report.id}')">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteReport('${report.id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </a>
                                </div>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Add some CSS for the dropdown styling
            const style = document.createElement('style');
            style.textContent = `
                .dropdown-item {
                    padding: 8px 20px;
                    cursor: pointer;
                }
                .dropdown-item:hover {
                    background-color: #f8f9fa;
                }
                .dropdown-item i {
                    margin-right: 8px;
                    width: 16px;
                }
                .dropdown-item.text-danger:hover {
                    background-color: #fff5f5;
                }
                .btn-primary.dropdown-toggle {
                    background-color: #ff5c97;
                    border-color: #ff5c97;
                }
                .btn-primary.dropdown-toggle:hover {
                    background-color: #ff3c7f;
                    border-color: #ff3c7f;
                }
            `;
            document.head.appendChild(style);

            // View report details
            function viewReport(id) {
                window.location.href = `report-details.html?id=${id}`;
            }

            // Function to handle successful update
            async function handleSuccessfulUpdate(form, submitBtn) {
                // Reset form and button
                form.reset();
                submitBtn.textContent = 'Submit Report';
                delete form.dataset.updateId;
                
                // Reset form handler to original submission
                form.onsubmit = handleReportSubmission;
                
                // First reload the reports to ensure we have fresh data
                await loadReports();
                
                // Then switch to view tab
                $('#dashboardTabs a[href="#view"]').tab('show');
                
                // Finally, update the display
                filterAndDisplayReports();
            }

            // Update report function
            async function updateReport(id) {
                const username = localStorage.getItem('username');
                if (!username) {
                    alert('Please login again');
                    window.location.href = 'login.html';
                    return;
                }

                // Find the report in the global data
                const report = window.reportData.find(r => r.id === id);
                if (!report) {
                    alert('Report not found');
                    return;
                }

                // Switch to the submit tab
                $('#dashboardTabs a[href="#submit"]').tab('show');

                // Populate the form with existing data
                const form = document.getElementById('fieldReportForm');
                
                // Reset form first
                form.reset();

                // Populate all form fields
                Object.keys(report).forEach(key => {
                    if (key !== 'id' && key !== 'timestamp' && key !== 'username') {
                        const input = form.elements[key];
                        if (input) {
                            if (input.type === 'file') {
                                // Skip file inputs as they can't be pre-populated
                                return;
                            } else if (input.type === 'textarea' || input.type === 'text' || 
                                     input.type === 'number' || input.type === 'tel' || 
                                     input.type === 'select-one') {
                                input.value = report[key] || '';
                            }
                        }
                    }
                });

                // Special handling for nested objects and arrays
                if (report.gpsCoordinates) {
                    document.getElementById('manualCoordinates').style.display = 'block';
                    document.getElementById('manualLatitude').value = report.gpsCoordinates.latitude || '';
                    document.getElementById('manualLongitude').value = report.gpsCoordinates.longitude || '';
                    document.getElementById('gpsCoordinates').innerHTML = 
                        `Latitude: ${report.gpsCoordinates.latitude}<br>Longitude: ${report.gpsCoordinates.longitude}`;
                }

                // Change the submit button to update
                const submitBtn = form.querySelector('.submit-btn');
                submitBtn.textContent = 'Update Report';
                form.dataset.updateId = id;

                // Modify the form submission handler
                form.onsubmit = async (event) => {
                    event.preventDefault();
                    
                    const formData = new FormData(form);
                    const data = {};
                    
                    // Collect all form fields, including empty ones
                    formData.forEach((value, key) => {
                        // Include all fields except file inputs
                        if (!(form.elements[key] && form.elements[key].type === 'file')) {
                            data[key] = value;
                        }
                    });

                    // Add GPS coordinates if available
                    const manualLatitude = document.getElementById('manualLatitude').value;
                    const manualLongitude = document.getElementById('manualLongitude').value;
                    if (manualLatitude || manualLongitude) {
                        data.gpsCoordinates = {
                            latitude: parseFloat(manualLatitude) || null,
                            longitude: parseFloat(manualLongitude) || null
                        };
                    }

                    // Preserve the original report ID
                    data.id = id;

                    try {
                        const response = await fetch(`${window.API_CONFIG.BASE_URL}/api/update-report/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${username}`
                            },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();
                        if (result.success) {
                            alert('Report updated successfully!');
                            await handleSuccessfulUpdate(form, submitBtn);
                        } else {
                            alert('Error updating report: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred while updating the report.');
                    }

                    return false;
                };
            }

            // Delete report function
            async function deleteReport(id) {
                const username = localStorage.getItem('username');
                if (!username) {
                    alert('Please login again');
                    window.location.href = 'login.html';
                    return;
                }

                if (!confirm('Are you sure you want to delete this report?')) {
                    return;
                }

                try {
                    const response = await fetch(`${window.API_CONFIG.BASE_URL}/api/delete-report/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${username}`
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert('Report deleted successfully!');
                        loadReports();
                    } else {
                        alert('Error deleting report: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the report.');
                }
            }

            // Download report function
            async function downloadReport(id) {
                const username = localStorage.getItem('username');
                if (!username) {
                    alert('Please login again');
                    window.location.href = 'login.html';
                    return;
                }

                try {
                    // First try to get the report data in JSON format
                    const dataResponse = await fetch(`${window.API_CONFIG.BASE_URL}/api/get-report/${id}?username=${encodeURIComponent(username)}`, {
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!dataResponse.ok) {
                        throw new Error('Failed to retrieve report data');
                    }
                    
                    const reportData = await dataResponse.json();
                    
                    // Now try the Excel download
                    const downloadUrl = `${window.API_CONFIG.BASE_URL}/api/download-report/${id}?username=${encodeURIComponent(username)}`;
                    
                    try {
                        // Try to download the Excel file
                        const response = await fetch(downloadUrl);
                        
                        // Check if the response is JSON (likely an error message)
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            if (!errorData.success) {
                                throw new Error(errorData.message || 'Unknown error occurred');
                            }
                        }
                        
                        // If we get here, it's likely a successful download
                        window.open(downloadUrl, '_blank');
                        
                    } catch (excelError) {
                        console.error('Excel download error:', excelError);
                        
                        // Show error message
                        const errorMsg = excelError.message || 'Unknown error';
                        console.error('Error downloading Excel:', errorMsg);
                        
                        // If Excel download fails, offer to display data in table format
                        const viewOption = confirm('Excel download failed. Would you like to view the report data in table format instead?');
                        
                        if (viewOption) {
                            // Display report data in table format
                            displayReportTable(reportData.report);
                        } else {
                            alert('Please try again later or contact the administrator.');
                        }
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert(`An error occurred while retrieving the report: ${error.message}`);
                }
            }
            
            // Function to display report data in table format
            function displayReportTable(report) {
                // Create a new window
                const reportWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
                
                // Generate HTML content with table format
                let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Report Data</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #ff5c97; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th { background-color: #f2f2f2; text-align: left; padding: 8px; border: 1px solid #ddd; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .print-btn { 
                            background: #ff5c97; 
                            color: white; 
                            border: none; 
                            padding: 10px 20px; 
                            border-radius: 5px; 
                            cursor: pointer; 
                            margin-bottom: 20px;
                        }
                        .section-title {
                            background-color: #ff5c97;
                            color: white;
                            padding: 10px;
                            margin-top: 20px;
                            margin-bottom: 10px;
                        }
                        .copy-btn {
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin-left: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h1>Report Details</h1>
                        <div>
                            <button class="print-btn" onclick="window.print()">Print Report</button>
                            <button class="copy-btn" onclick="copyTableToClipboard()">Copy to Clipboard</button>
                        </div>
                    </div>
                `;
                
                // Add timestamp if available
                if (report.timestamp) {
                    const date = new Date(report.timestamp).toLocaleDateString('en-GB');
                    htmlContent += `<p><strong>Date:</strong> ${date}</p>`;
                }
                
                // Client Information Section
                htmlContent += `
                    <div class="section-title">Client Information</div>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Client Name</td>
                            <td>${report.clientName || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Serial Number</td>
                            <td>${report.serialNumber || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Bank/Branch Name</td>
                            <td>${report.bankName || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Contact Number</td>
                            <td>${report.contactNumber || 'N/A'}</td>
                        </tr>
                    </table>
                `;
                
                // Plot Details Section
                htmlContent += `
                    <div class="section-title">Plot Details</div>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Plot No</td>
                            <td>${report.plotNo || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Plot Area</td>
                            <td>${report.plotArea || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Location (Tole Name)</td>
                            <td>${report.toleName || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Boundaries Analysis</td>
                            <td>${report.boundariesAnalysis || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Field Dimensions</td>
                            <td>${report.fieldDimensions || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Cadastral Dimensions</td>
                            <td>${report.cadastralDimensions || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Road Width (Cadastral)</td>
                            <td>${report.roadWidthCadastral || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Road Width (Right of Way)</td>
                            <td>${report.roadWidthRightOfWay || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Road Type</td>
                            <td>${report.roadType || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Other Factors</td>
                            <td>${report.otherFactors || 'N/A'}</td>
                        </tr>
                    </table>
                `;
                
                // Land Status Section
                htmlContent += `
                    <div class="section-title">Land Status and Use</div>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Land Status</td>
                            <td>${report.landStatus || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Land Use</td>
                            <td>${report.landUse || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Land Grading</td>
                            <td>${report.landGrading || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Surrounding Property</td>
                            <td>${report.surroundingProperty || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Filling Requirement</td>
                            <td>${report.fillingRequirement || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Area Importance</td>
                            <td>${report.areaImportance || 'N/A'}</td>
                        </tr>
                    </table>
                `;
                
                // Document Verification Section
                htmlContent += `
                    <div class="section-title">Document Verification</div>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Documents Provided</td>
                            <td>${report.documentsProvided || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Shape Match</td>
                            <td>${report.shapeMatch || 'N/A'}</td>
                        </tr>
                    </table>
                `;
                
                // Distances & Location Section
                htmlContent += `
                    <div class="section-title">Distances & Location Factors</div>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Landmarks</td>
                            <td>${report.landmarks || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Tension Line Proximity</td>
                            <td>${report.tensionLineProximity || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Water Body Proximity</td>
                            <td>${report.waterBodyProximity || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Border Distance</td>
                            <td>${report.borderDistance || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Government Notifications</td>
                            <td>${report.govtNotifications || 'N/A'}</td>
                        </tr>
                    </table>
                `;
                
                // Building Section
                htmlContent += `
                    <div class="section-title">Building & Construction Details</div>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Construction Approval</td>
                            <td>${report.constructionApproval || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Structure Type</td>
                            <td>${report.structureType || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Completion Year</td>
                            <td>${report.completionYear || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Completed Floors</td>
                            <td>${report.completedFloors || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Maintenance Requirements</td>
                            <td>${report.maintenanceReq || 'N/A'}</td>
                        </tr>
                    </table>
                `;
                
                // Market Rate Section
                htmlContent += `
                    <div class="section-title">Market Rate</div>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Market Rate (Person-1)</td>
                            <td>${report.marketRate1 || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Market Rate (Person-2)</td>
                            <td>${report.marketRate2 || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Market Rate (Person-3)</td>
                            <td>${report.marketRate3 || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Market Rate (Person-4)</td>
                            <td>${report.marketRate4 || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Market Rate (Person-5)</td>
                            <td>${report.marketRate5 || 'N/A'}</td>
                        </tr>
                    </table>
                `;
                
                // Valuation Summary Section
                htmlContent += `
                    <div class="section-title">Valuation Summary</div>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Valuer's Opinion</td>
                            <td>${report.valuersOpinion || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Value Basis</td>
                            <td>${report.valueBasis || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Valuator Name</td>
                            <td>${report.valuatorName || 'N/A'}</td>
                        </tr>
                    </table>
                `;
                
                // Add script for copying table to clipboard
                htmlContent += `
                    <script>
                        function copyTableToClipboard() {
                            // Create a temporary textarea element
                            const textarea = document.createElement('textarea');
                            
                            // Get all tables
                            const tables = document.querySelectorAll('table');
                            let text = '';
                            
                            // For each table
                            tables.forEach((table, tableIndex) => {
                                // Get the section title
                                const sectionTitle = document.querySelectorAll('.section-title')[tableIndex].textContent;
                                text += sectionTitle + '\\n\\n';
                                
                                // Get all rows
                                const rows = table.querySelectorAll('tr');
                                
                                // For each row
                                rows.forEach(row => {
                                    // Get all cells
                                    const cells = row.querySelectorAll('th, td');
                                    
                                    // For each cell
                                    cells.forEach((cell, index) => {
                                        // Add cell text
                                        text += cell.textContent;
                                        
                                        // Add tab between cells
                                        if (index < cells.length - 1) {
                                            text += '\\t';
                                        }
                                    });
                                    
                                    // Add new line after each row
                                    text += '\\n';
                                });
                                
                                // Add extra new line between tables
                                text += '\\n';
                            });
                            
                            // Set textarea value
                            textarea.value = text;
                            
                            // Append textarea to body
                            document.body.appendChild(textarea);
                            
                            // Select textarea content
                            textarea.select();
                            
                            // Copy selected content
                            document.execCommand('copy');
                            
                            // Remove textarea
                            document.body.removeChild(textarea);
                            
                            // Alert user
                            alert('Report data copied to clipboard. You can now paste it into Excel.');
                        }
                    </script>
                `;
                
                // Close HTML
                htmlContent += `
                </body>
                </html>
                `;
                
                // Write to the new window
                reportWindow.document.write(htmlContent);
                reportWindow.document.close();
            }
        </script>

        <!-- JS here -->
        <script src="./assets/js/vendor/modernizr-3.5.0.min.js"></script>
        <script src="./assets/js/vendor/jquery-1.12.4.min.js"></script>
        <script src="./assets/js/popper.min.js"></script>
        <script src="./assets/js/bootstrap.min.js"></script>
        <script src="./assets/js/jquery.slicknav.min.js"></script>
        <script src="./assets/js/owl.carousel.min.js"></script>
        <script src="./assets/js/slick.min.js"></script>
        <script src="./assets/js/wow.min.js"></script>
        <script src="./assets/js/animated.headline.js"></script>
        <script src="./assets/js/jquery.magnific-popup.js"></script>
        <script src="./assets/js/jquery.nice-select.min.js"></script>
        <script src="./assets/js/jquery.sticky.js"></script>
        <script src="./assets/js/main.js"></script>
        <script src="config.js"></script>
    </body>
</html> 